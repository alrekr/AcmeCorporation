@page "/admin/entries"
@using AcmeCorporation.Library.Datacontracts
@using AcmeCorporation.Library.Service
@using Microsoft.AspNetCore.Authorization

@attribute [Authorize(Roles = UserRole.Administrator)]
@inject IEntryService EntryService
@implements IDisposable

<h3>Raffle Entries</h3>

@if (_isLoading)
{
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
}
else if (_result.Items is null || !_result.Items.Any())
{
    <div class="alert alert-info">No entries found</div>
}
else
{
    <div class="table-responsive">
        <table class="table table-striped table-hover">
            <thead>
                <tr>
                    <th>Date (UTC)</th>
                    <th>First name</th>
                    <th>Last name</th>
                    <th>Email</th>
                    <th>Serial number</th>

                </tr>
            </thead>
            <tbody>
                @foreach (RaffleEntryViewDto entry in _result.Items)
                {
                    <tr>
                        <td>@entry.EntryDateTimeUtc.ToString("yyyy-MM-dd HH:mm")</td>
                        <td>@entry.FirstName</td>
                        <td>@entry.LastName</td>
                        <td>@entry.Email</td>
                        <td class="font-monospace">@entry.SerialNumber</td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
}

<nav aria-label="Raffle navigation">
    <ul class="pagination justify-content-center">
        <li class="page-item @(_currentPage == 1 ? "disabled" : "")">
            <button class="page-link" @onclick="() => ChangePage(_currentPage - 1)">Previous</button>
        </li>
        <li class="page-item disabled">
            <span class="page-link">
                Page @_currentPage @PageTotal
            </span>
        </li>
        <li class="page-item @(_currentPage >= _result?.TotalPages ? "disabled" : "")">
            <button class="page-link" @onclick="() => ChangePage(_currentPage + 1)">Next</button>
        </li>
    </ul>
</nav>

@code
{
    private PagedResult<RaffleEntryViewDto>? _result;
    private bool _isLoading = true;
    private int _currentPage = 1;
    private const int PageSize = 10;
    private string PageTotal => _result == null ? string.Empty : $" of {_result.TotalPages} (total entries: {_result.TotalCount})";

    private CancellationTokenSource? _cts;

    protected override async Task OnInitializedAsync()
    {
        await LoadDataAsync();
    }

    private async Task ChangePage(int newPage)
    {
        if (newPage < 1 || (_result != null && newPage > _result.TotalPages))
        {
            return;
        }

        _currentPage = newPage;
        await LoadDataAsync();
    }

    private async Task LoadDataAsync()
    {
        _cts?.Cancel();
        _cts = new CancellationTokenSource();
        _isLoading = true;

        StateHasChanged();

        try
        {
            _result = await EntryService.GetPagedEntriesAsync(_currentPage, PageSize, _cts.Token);
        }
        catch (OperationCanceledException)
        {
            // we're ignoring this
        }
        finally
        {
            _isLoading = false;
        }
    }

    public void Dispose()
    {
        _cts?.Cancel();
        _cts?.Dispose();
    }
}
